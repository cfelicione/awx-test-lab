---
- name: Deploy /etc/hosts from repo (AWX)
  hosts: localhost
  gather_facts: false

  vars:
    hosts_src: "files/hosts"
    hosts_dst: "/etc/hosts"
    backup_dir: "/var/backups/awx"
    backup_suffix: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

  pre_tasks:
    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Backup current /etc/hosts (if present)
      ansible.builtin.copy:
        src: "{{ hosts_dst }}"
        dest: "{{ backup_dir }}/hosts.{{ inventory_hostname }}.{{ backup_suffix }}"
        remote_src: true
        owner: root
        group: root
        mode: "0644"
      ignore_errors: true

    - name: Verify hosts file exists in repo on controller (AWX project)
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../{{ hosts_src }}"
      delegate_to: localhost
      run_once: true
      register: repo_hosts

    - name: Fail if repo hosts file is missing
      ansible.builtin.fail:
        msg: "Missing {{ hosts_src }} in the project repo. Put it under files/hosts."
      when: not repo_hosts.stat.exists
      delegate_to: localhost
      run_once: true

  tasks:
    - name: Deploy /etc/hosts
      ansible.builtin.copy:
        src: "{{ hosts_src }}"
        dest: "{{ hosts_dst }}"
        owner: root
        group: root
        mode: "0644"
        backup: true

    # Opzionale: controllino leggero (evita righe completamente rotte)
    - name: Basic sanity check of /etc/hosts
      ansible.builtin.shell: |
        awk '
          /^[[:space:]]*$/ {next}
          /^[[:space:]]*#/ {next}
          NF < 2 {bad=1; print "BAD:", $0}
        END {exit bad}
        ' /etc/hosts
      args:
        executable: /bin/bash
      changed_when: false

